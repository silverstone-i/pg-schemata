<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

## DB

DB is a singleton utility class that initializes and provides access
to a configured pg-promise database instance. It also auto-attaches
custom repositories to the DB object on first initialization.

Use `DB.init(connection, repositories)` once at startup to initialize the DB.
Then access `DB.db` and `DB.pgp` as needed throughout your application.

### db

### pgp

### init

Initializes the DB singleton if it hasn't been initialized yet.

#### Parameters

*   `connection` **([object][75] | [string][76])** A pg-promise-compatible connection object or string.
*   `repositories` **[Object][75]<[string][76], [Function][77]>** A map of repository names to their constructors.
*   `logger` **[object][75]** Optional logger passed to each repository. (optional, default `null`)

<!---->

*   Throws **[Error][78]** If connection or repositories are invalid.

## pgp

The initialized pg-promise instance.

## db

The initialized pg-promise database instance.

## TableModel

**Extends QueryModel**

TableModel extends QueryModel to provide full read/write support for a PostgreSQL table.

Adds create, update, and delete capabilities on top of the read-only features in QueryModel,
along with support for spreadsheet import/export, validation, and conditional mutations.

✅ Features:

*   Full CRUD: `insert`, `update`, `delete`, `deleteWhere`, `updateWhere`
*   Cursor-based and paginated queries via `findAfterCursor`
*   Bulk operations: `bulkInsert`, `bulkUpdate`
*   Data import/export: `importFromSpreadsheet`, `exportToSpreadsheet`
*   Auto Zod schema validation and field sanitization

This class is the standard entry point for interacting with a single table in pg-schemata.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger` &#x20;

### delete

Deletes a record by its ID.

#### Parameters

*   `id` **([string][76] | [number][79])** Primary key of the row to delete.

<!---->

*   Throws **[Error][78]** If the ID is invalid or deletion fails.

Returns **[Promise][80]<[number][79]>** Number of rows deleted.

### insert

Inserts a single row into the table after validation and sanitization.

#### Parameters

*   `dto` **[Object][75]** Data to insert.

<!---->

*   Throws **[SchemaDefinitionError][42]** If validation fails or DTO is invalid.

Returns **[Promise][80]<[Object][75]>** The inserted row.

### reload

Reloads a single record by ID using findById.

#### Parameters

*   `id` **([string][76] | [number][79])** Primary key value.

Returns **[Promise][80]<([Object][75] | null)>** The found record or null.

### update

Updates a record by ID with new data.

#### Parameters

*   `id` **([string][76] | [number][79])** Primary key value.
*   `dto` **[Object][75]** Updated values.

<!---->

*   Throws **[SchemaDefinitionError][42]** If ID or DTO is invalid.

Returns **[Promise][80]<([Object][75] | null)>** Updated record or null if not found.

### findAfterCursor

Retrieves a paginated set of rows after a cursor position.

#### Parameters

*   `cursor` **[Object][75]** Cursor values keyed by orderBy columns. (optional, default `{}`)
*   `limit` **[number][79]** Max number of rows to return. (optional, default `50`)
*   `orderBy` **[Array][81]<[string][76]>** Columns used for pagination ordering. (optional, default `['id']`)
*   `options` **[Object][75]** Extra filters and options. (optional, default `{}`)

### deleteWhere

Deletes rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][75] | [Array][81])** Filter criteria.

Returns **[Promise][80]<[number][79]>** Number of rows deleted.

### touch

Updates only the updated\_by timestamp for a given row.

#### Parameters

*   `id` **([string][76] | [number][79])** Primary key.
*   `updatedBy` **[string][76]** User performing the update. (optional, default `'system'`)

Returns **[Promise][80]<([Object][75] | null)>** Updated row.

### updateWhere

Updates rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][75] | [Array][81])** Conditions.
*   `updates` **[Object][75]** Fields to update.

<!---->

*   Throws **[SchemaDefinitionError][42]** If input is invalid.

Returns **[Promise][80]<[number][79]>** Number of rows updated.

### bulkInsert

Inserts many rows in a single batch operation.

#### Parameters

*   `records` **[Array][81]<[Object][75]>** Rows to insert.

<!---->

*   Throws **[SchemaDefinitionError][42]** If records are invalid.

Returns **[Promise][80]<[number][79]>** Number of rows inserted.

### bulkUpdate

Updates multiple rows using their primary keys.

#### Parameters

*   `records` **[Array][81]<[Object][75]>** Each must include an ID field.

<!---->

*   Throws **[SchemaDefinitionError][42]** If input or IDs are invalid.

Returns **[Promise][80]<[Array][81]<[number][79]>>** Array of row counts updated per query.

### exportToSpreadsheet

Exports table data to an Excel file based on filter criteria.

#### Parameters

*   `filePath` **[string][76]** Destination .xlsx path.
*   `where` **[Array][81]** Optional conditions. (optional, default `[]`)
*   `joinType` **[string][76]** Join type between conditions. (optional, default `'AND'`)
*   `options` **[Object][75]** Additional query options. (optional, default `{}`)

Returns **[Promise][80]<{exported: [number][79], filePath: [string][76]}>**&#x20;

### importFromSpreadsheet

Loads data from an Excel file and inserts it into the table.

#### Parameters

*   `filePath` **[string][76]** Source .xlsx file path.
*   `sheetIndex` **[number][79]** Sheet index to load. (optional, default `0`)

<!---->

*   Throws **[SchemaDefinitionError][42]** If file format is invalid.

Returns **[Promise][80]<{inserted: [number][79]}>**&#x20;

### sanitizeDto

Returns a sanitized copy of the input, filtering out invalid or immutable columns.

#### Parameters

*   `dto` **[Object][75]** Input object.
*   `options` **[Object][75]?**  (optional, default `{}`)

    *   `options.includeImmutable` **[boolean][82]**  (optional, default `true`)

Returns **[Object][75]** Sanitized DTO.

### setSchema

Sets a new schema name in the internal schema.

#### Parameters

*   `dbSchema` **[string][76]** New schema name.

### truncate

Truncates the table and resets its identity sequence.

Returns **[Promise][80]\<void>**&#x20;

### withSchema

Sets a new schema name and returns the current model instance.

#### Parameters

*   `dbSchema` **[string][76]** New schema name.

Returns **[TableModel][8]**&#x20;

### createTable

Creates the table using the current schema definition.

Returns **[Promise][80]\<void>**&#x20;

## SchemaDefinitionError

**Extends Error**

Custom error used to indicate problems with table schema definitions or data validation
within pg-schemata. This is typically thrown during insert/update validation or schema parsing.

### Parameters

*   `message` **[string][76]** Error message describing the schema issue.
*   `originalError` **([Error][78] | null)** Optional original error cause for tracing. (optional, default `null`)

## createHash

Creates a short MD5-based hash of the input string.

### Parameters

*   `input` **[string][76]** Value to hash.

Returns **[string][76]** A 6-character hex hash.

## QueryModel

QueryModel provides reusable read-only query logic for PostgreSQL tables.

Designed for models that require flexible query-building capabilities, either as a standalone
read-only interface or to be extended for full CRUD functionality.

It may be instantiated directly when only read-access is required.

✅ Features:

*   Dynamic WHERE clause generation via `buildWhereClause` and `buildCondition`
*   Query helpers: `findWhere`, `findAll`, `findOneBy`
*   Aggregations and checks: `count`, `countAll`, `exists`
*   Rich condition syntax with `$like`, `$from`, `$eq`, `$in`, `$and`, `$or`, etc.

📌 See [where-modifiers.md][83] for full reference.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger`   (optional, default `null`)

### findAll

Fetches all rows from the table with optional pagination.

#### Parameters

*   `options` **[Object][75]** Query options. (optional, default `{}`)

    *   `options.limit` **[number][79]** Maximum number of records to return. (optional, default `50`)
    *   `options.offset` **[number][79]** Number of records to skip. (optional, default `0`)

Returns **[Promise][80]<[Array][81]<[Object][75]>>** List of rows.

### findById

Finds a single row by its ID.

#### Parameters

*   `id` **([number][79] | [string][76])** The primary key value.

<!---->

*   Throws **[Error][78]** If ID is invalid.

Returns **[Promise][80]<([Object][75] | null)>** Matching row or null if not found.

### findWhere

Finds rows matching conditions and optional filters.

#### Parameters

*   `conditions` **[Array][81]<[Object][75]>** Array of condition objects. (optional, default `[]`)
*   `joinType` **[string][76]** Logical operator ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][75]** Query options. (optional, default `{}`)

    *   `options.columnWhitelist` **[Array][81]<[string][76]>?** Columns to return. (optional, default `null`)
    *   `options.filters` **[Object][75]?** Additional filter object. (optional, default `{}`)
    *   `options.orderBy` **([string][76] | [Array][81]<[string][76]>)?** Sort columns. (optional, default `null`)
    *   `options.limit` **[number][79]?** Limit results. (optional, default `null`)
    *   `options.offset` **[number][79]?** Offset results. (optional, default `null`)

Returns **[Promise][80]<[Array][81]<[Object][75]>>** Matching rows.

### findOneBy

Finds the first row matching the given conditions.

#### Parameters

*   `conditions` **[Array][81]<[Object][75]>** Condition list.
*   `options` **[Object][75]?** Query options (same as findWhere). (optional, default `{}`)

Returns **[Promise][80]<([Object][75] | null)>** First matching row or null.

### exists

Checks if any row exists matching the given conditions.

#### Parameters

*   `conditions` **[Object][75]** Condition object.

<!---->

*   Throws **[Error][78]** If conditions are invalid.

Returns **[Promise][80]<[boolean][82]>** True if a match is found.

### count

Counts the number of rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][75] | [Array][81]<[Object][75]>)** WHERE condition(s).

Returns **[Promise][80]<[number][79]>** Number of matching rows.

### countAll

Counts all rows in the table.

Returns **[Promise][80]<[number][79]>** Total row count.

### escapeName

Escapes a column or table name using pg-promise syntax.

#### Parameters

*   `name` **[string][76]** Unescaped identifier.

Returns **[string][76]** Escaped name.

### setSchemaName

Sets a new schema name and regenerates the column set.

#### Parameters

*   `name` **[string][76]** The new schema name.

<!---->

*   Throws **[Error][78]** If name is invalid.

Returns **[QueryModel][46]** The updated model instance.

### buildWhereClause

Builds a SQL WHERE clause from conditions.

#### Parameters

*   `where` **([Object][75] | [Array][81]<[Object][75]>)** Conditions object or array. (optional, default `{}`)
*   `requireNonEmpty` **[boolean][82]** Enforce non-empty input. (optional, default `true`)
*   `values` **[Array][81]** Array to accumulate parameter values. (optional, default `[]`)
*   `joinType` **[string][76]** Logical operator for combining. (optional, default `'AND'`)

<!---->

*   Throws **[Error][78]** If input is invalid or empty when required.

Returns **{clause: [string][76], values: [Array][81]}** Clause and parameter list.

### buildCondition

Builds a SQL fragment from a group of conditions, supporting nested logic and advanced operators.

🔍 Supports field-level modifiers like `$like`, `$from`, `$in`, etc.
🔁 Also supports nested boolean logic via `$and`, `$or`, `and`, `or`.

📘 See full documentation:
[WHERE Clause Modifiers Reference][83]

#### Parameters

*   `group` **[Array][81]<[Object][75]>** Array of condition objects.
*   `joiner` **[string][76]** Logical joiner ('AND' or 'OR') between conditions. (optional, default `'AND'`)
*   `values` **[Array][81]** Parameter values to be populated. (optional, default `[]`)

Returns **[string][76]** A SQL-safe WHERE fragment.

### handleDbError

Handles known pg errors and logs them.

#### Parameters

*   `err` **[Error][78]** The error thrown by pg-promise.

<!---->

*   Throws **[DatabaseError][73]** Translated database error.

## callDb

Returns a schema-aware version of a registered model or repository.

### Parameters

*   `modelOrName` **([string][76] | [object][75])** The model instance or its name.
*   `schemaName` **[string][76]** The database schema to bind.

Returns **[object][75]** The model bound to the given schema.

## DatabaseError

**Extends Error**

Custom error class for representing PostgreSQL-related database errors.
Wraps the original error thrown by pg-promise or pg, and extracts useful metadata
such as the constraint name, table, and SQLSTATE error code.

### Parameters

*   `message` **[string][76]** A human-readable description of the error.
*   `originalError` **[Error][78]** The original error object from PostgreSQL.

[1]: #db

[2]: #db-1

[3]: #pgp

[4]: #init

[5]: #parameters

[6]: #pgp-1

[7]: #db-2

[8]: #tablemodel

[9]: #parameters-1

[10]: #delete

[11]: #parameters-2

[12]: #insert

[13]: #parameters-3

[14]: #reload

[15]: #parameters-4

[16]: #update

[17]: #parameters-5

[18]: #findaftercursor

[19]: #parameters-6

[20]: #deletewhere

[21]: #parameters-7

[22]: #touch

[23]: #parameters-8

[24]: #updatewhere

[25]: #parameters-9

[26]: #bulkinsert

[27]: #parameters-10

[28]: #bulkupdate

[29]: #parameters-11

[30]: #exporttospreadsheet

[31]: #parameters-12

[32]: #importfromspreadsheet

[33]: #parameters-13

[34]: #sanitizedto

[35]: #parameters-14

[36]: #setschema

[37]: #parameters-15

[38]: #truncate

[39]: #withschema

[40]: #parameters-16

[41]: #createtable

[42]: #schemadefinitionerror

[43]: #parameters-17

[44]: #createhash

[45]: #parameters-18

[46]: #querymodel

[47]: #parameters-19

[48]: #findall

[49]: #parameters-20

[50]: #findbyid

[51]: #parameters-21

[52]: #findwhere

[53]: #parameters-22

[54]: #findoneby

[55]: #parameters-23

[56]: #exists

[57]: #parameters-24

[58]: #count

[59]: #parameters-25

[60]: #countall

[61]: #escapename

[62]: #parameters-26

[63]: #setschemaname

[64]: #parameters-27

[65]: #buildwhereclause

[66]: #parameters-28

[67]: #buildcondition

[68]: #parameters-29

[69]: #handledberror

[70]: #parameters-30

[71]: #calldb

[72]: #parameters-31

[73]: #databaseerror

[74]: #parameters-32

[75]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[76]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[77]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[78]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error

[79]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[80]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

[81]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[82]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[83]: where-modifiers.md
