<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [DB][1]
    *   [init][2]
        *   [Parameters][3]
*   [pgp][4]
*   [db][5]
*   [TableModel][6]
    *   [Parameters][7]
    *   [delete][8]
        *   [Parameters][9]
    *   [insert][10]
        *   [Parameters][11]
    *   [reload][12]
        *   [Parameters][13]
    *   [update][14]
        *   [Parameters][15]
    *   [findAfterCursor][16]
        *   [Parameters][17]
    *   [deleteWhere][18]
        *   [Parameters][19]
    *   [touch][20]
        *   [Parameters][21]
    *   [updateWhere][22]
        *   [Parameters][23]
    *   [bulkInsert][24]
        *   [Parameters][25]
    *   [bulkUpdate][26]
        *   [Parameters][27]
    *   [exportToSpreadsheet][28]
        *   [Parameters][29]
    *   [importFromSpreadsheet][30]
        *   [Parameters][31]
    *   [removeWhere][32]
        *   [Parameters][33]
    *   [restoreWhere][34]
        *   [Parameters][35]
    *   [purgeSoftDeleteWhere][36]
        *   [Parameters][37]
    *   [purgeSoftDeleteById][38]
        *   [Parameters][39]
    *   [validateDto][40]
        *   [Parameters][41]
    *   [sanitizeDto][42]
        *   [Parameters][43]
    *   [truncate][44]
    *   [createTable][45]
*   [SchemaDefinitionError][46]
    *   [Parameters][47]
*   [createHash][48]
    *   [Parameters][49]
*   [QueryModel][50]
    *   [Parameters][51]
    *   [findSoftDeleted][52]
        *   [Parameters][53]
    *   [isSoftDeleted][54]
        *   [Parameters][55]
    *   [findAll][56]
        *   [Parameters][57]
    *   [findById][58]
        *   [Parameters][59]
    *   [findByIdIncludingDeactivated][60]
        *   [Parameters][61]
    *   [findWhere][62]
        *   [Parameters][63]
    *   [findOneBy][64]
        *   [Parameters][65]
    *   [exists][66]
        *   [Parameters][67]
    *   [count][68]
        *   [Parameters][69]
    *   [countAll][70]
    *   [escapeName][71]
        *   [Parameters][72]
    *   [setSchemaName][73]
        *   [Parameters][74]
    *   [buildWhereClause][75]
        *   [Parameters][76]
    *   [buildCondition][77]
        *   [Parameters][78]
    *   [handleDbError][79]
        *   [Parameters][80]
*   [callDb][81]
    *   [Parameters][82]
*   [DatabaseError][83]
    *   [Parameters][84]

## DB

DB is a singleton utility class that initializes and provides access
to a configured pg-promise database instance. It also auto-attaches
custom repositories to the DB object on first initialization.

Use `DB.init(connection, repositories)` once at startup to initialize the DB.
Then access `DB.db` and `DB.pgp` as needed throughout your application.

### init

Initializes the DB singleton if it hasn't been initialized yet.

#### Parameters

*   `connection` **([object][85] | [string][86])** A pg-promise-compatible connection object or string.
*   `repositories` **[Object][85]<[string][86], [Function][87]>** A map of repository names to their constructors.
*   `logger` **[object][85]** Optional logger passed to each repository. (optional, default `null`)

<!---->

*   Throws **[Error][88]** If connection or repositories are invalid.

## pgp

The initialized pg-promise instance.

## db

The initialized pg-promise database instance.

## TableModel

**Extends QueryModel**

TableModel extends QueryModel to provide full read/write support for a PostgreSQL table.

Adds create, update, and delete capabilities on top of the read-only features in QueryModel,
along with support for spreadsheet import/export, validation, and conditional mutations.

✅ Features:

*   Full CRUD: `insert`, `update`, `delete`, `deleteWhere`, `updateWhere`
*   Cursor-based and paginated queries via `findAfterCursor`
*   Bulk operations: `bulkInsert`, `bulkUpdate`
*   Data import/export: `importFromSpreadsheet`, `exportToSpreadsheet`
*   Auto Zod schema validation and field sanitization

This class is the standard entry point for interacting with a single table in pg-schemata.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger` &#x20;

### delete

Deletes a record by its ID.

#### Parameters

*   `id` **([string][86] | [number][89])** Primary key of the row to delete.

<!---->

*   Throws **[Error][88]** If the ID is invalid or deletion fails.

Returns **[Promise][90]<[number][89]>** Number of rows deleted.

### insert

Inserts a single row into the table after validation and sanitization.

#### Parameters

*   `dto` **[Object][85]** Data to insert.

<!---->

*   Throws **[SchemaDefinitionError][46]** If validation fails or DTO is invalid.

Returns **[Promise][90]<[Object][85]>** The inserted row.

### reload

Reloads a single record by ID using findById.

#### Parameters

*   `id` **([string][86] | [number][89])** Primary key value.
*   `options` **[Object][85]?** Optional flags. (optional, default `{}`)

    *   `options.includeDeactivated` **[boolean][91]** Whether to include soft-deleted records. (optional, default `false`)

Returns **[Promise][90]<([Object][85] | null)>** The found record or null.

### update

Updates a record by ID with new data.

#### Parameters

*   `id` **([string][86] | [number][89])** Primary key value.
*   `dto` **[Object][85]** Updated values.

<!---->

*   Throws **[SchemaDefinitionError][46]** If ID or DTO is invalid.

Returns **[Promise][90]<([Object][85] | null)>** Updated record or null if not found.

### findAfterCursor

Retrieves a paginated set of rows after a cursor position.

#### Parameters

*   `cursor` **[Object][85]** Cursor values keyed by orderBy columns. (optional, default `{}`)
*   `limit` **[number][89]** Max number of rows to return. (optional, default `50`)
*   `orderBy` **[Array][92]<[string][86]>** Columns used for pagination ordering. (optional, default `['id']`)
*   `options` **[Object][85]** Extra filters and options. (optional, default `{}`)

### deleteWhere

Deletes rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][85] | [Array][92])** Filter criteria.

Returns **[Promise][90]<[number][89]>** Number of rows deleted.

### touch

Updates only the updated\_by timestamp for a given row.

#### Parameters

*   `id` **([string][86] | [number][89])** Primary key.
*   `updatedBy` **[string][86]** User performing the update. (optional, default `'system'`)

Returns **[Promise][90]<([Object][85] | null)>** Updated row.

### updateWhere

Updates rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][85] | [Array][92])** Conditions.
*   `updates` **[Object][85]** Fields to update.
*   `options` **[Object][85]** Additional options (e.g., includeDeactivated). (optional, default `{}`)

<!---->

*   Throws **[SchemaDefinitionError][46]** If input is invalid.

Returns **[Promise][90]<[number][89]>** Number of rows updated.

### bulkInsert

Inserts many rows in a single batch operation.

#### Parameters

*   `records` **[Array][92]<[Object][85]>** Rows to insert.

<!---->

*   Throws **[SchemaDefinitionError][46]** If records are invalid.

Returns **[Promise][90]<[number][89]>** Number of rows inserted.

### bulkUpdate

Updates multiple rows using their primary keys.

#### Parameters

*   `records` **[Array][92]<[Object][85]>** Each must include an ID field.

<!---->

*   Throws **[SchemaDefinitionError][46]** If input or IDs are invalid.

Returns **[Promise][90]<[Array][92]<[number][89]>>** Array of row counts updated per query.

### exportToSpreadsheet

Exports table data to an Excel file based on filter criteria.

#### Parameters

*   `filePath` **[string][86]** Destination .xlsx path.
*   `where` **[Array][92]** Optional conditions. (optional, default `[]`)
*   `joinType` **[string][86]** Join type between conditions. (optional, default `'AND'`)
*   `options` **[Object][85]** Additional query options. (optional, default `{}`)

Returns **[Promise][90]<{exported: [number][89], filePath: [string][86]}>**&#x20;

### importFromSpreadsheet

Loads data from an Excel file and inserts it into the table.

#### Parameters

*   `filePath` **[string][86]** Source .xlsx file path.
*   `sheetIndex` **[number][89]** Sheet index to load. (optional, default `0`)

<!---->

*   Throws **[SchemaDefinitionError][46]** If file format is invalid.

Returns **[Promise][90]<{inserted: [number][89]}>**&#x20;

### removeWhere

Soft deletes records matching a WHERE clause by setting deactivated\_at = NOW().

#### Parameters

*   `where` **([Object][85] | [Array][92])** Filter criteria.

Returns **[Promise][90]<[number][89]>** Number of rows updated.

### restoreWhere

Restores previously soft-deleted records by setting deactivated\_at = NULL.

#### Parameters

*   `where` **([Object][85] | [Array][92])** Filter criteria.

Returns **[Promise][90]<[number][89]>** Number of rows updated.

### purgeSoftDeleteWhere

Permanently deletes soft-deleted records that match a given condition.
Useful for scheduled cleanup of records older than a threshold.

#### Parameters

*   `where` **([Object][85] | [Array][92]<[Object][85]>)** Filter conditions. (optional, default `[]`)

Returns **[Promise][90]<[Object][85]>** pg-promise result.

### purgeSoftDeleteById

Permanently deletes a soft-deleted row by ID.

#### Parameters

*   `id` **([string][86] | [number][89])** Primary key value.

Returns **[Promise][90]<[Object][85]>** pg-promise result.

### validateDto

Validates a single DTO or an array of DTOs using a Zod validator.

#### Parameters

*   `data` **([Object][85] | [Array][92]<[Object][85]>)** The DTO or array of DTOs to validate.
*   `validator` &#x20;
*   `type` **[string][86]** Optional label used in error messages. (optional, default `'DTO'`)

<!---->

*   Throws **[SchemaDefinitionError][46]** If validation fails. The `.cause` property contains Zod error details.

### sanitizeDto

Returns a sanitized copy of the input, filtering out invalid or immutable columns.

#### Parameters

*   `dto` **[Object][85]** Input object.
*   `options` **[Object][85]?**  (optional, default `{}`)

    *   `options.includeImmutable` **[boolean][91]**  (optional, default `true`)

Returns **[Object][85]** Sanitized DTO.

### truncate

Truncates the table and resets its identity sequence.

Returns **[Promise][90]\<void>**&#x20;

### createTable

Creates the table using the current schema definition.

Returns **[Promise][90]\<void>**&#x20;

## SchemaDefinitionError

**Extends Error**

Custom error used to indicate problems with table schema definitions or data validation
within pg-schemata. This is typically thrown during insert/update validation or schema parsing.

### Parameters

*   `message` **[string][86]** Error message describing the schema issue.
*   `originalError` **([Error][88] | null)** Optional original error cause for tracing. (optional, default `null`)

## createHash

Creates a short MD5-based hash of the input string.

### Parameters

*   `input` **[string][86]** Value to hash.

Returns **[string][86]** A 6-character hex hash.

## QueryModel

QueryModel provides reusable read-only query logic for PostgreSQL tables.

Designed for models that require flexible query-building capabilities, either as a standalone
read-only interface or to be extended for full CRUD functionality.

It may be instantiated directly when only read-access is required.

✅ Features:

*   Dynamic WHERE clause generation via `buildWhereClause` and `buildCondition`
*   Query helpers: `findWhere`, `findAll`, `findOneBy`
*   Aggregations and checks: `count`, `countAll`, `exists`
*   Rich condition syntax with `$like`, `$from`, `$eq`, `$in`, `$and`, `$or`, etc.

📌 See [where-modifiers.md][93] for full reference.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger`   (optional, default `null`)

### findSoftDeleted

Finds only soft-deleted records.

#### Parameters

*   `conditions` **[Array][92]<[Object][85]>** Optional extra conditions. (optional, default `[]`)
*   `joinType` **[string][86]** Logical joiner ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][85]** Query options. (optional, default `{}`)

Returns **[Promise][90]<[Array][92]<[Object][85]>>** Soft-deleted rows.

### isSoftDeleted

Checks if a specific record is soft-deleted.

#### Parameters

*   `id` **([number][89] | [string][86])** The primary key value.

Returns **[Promise][90]<[boolean][91]>** True if the record is soft-deleted, false otherwise.

### findAll

Fetches all rows from the table with optional pagination.

#### Parameters

*   `options` **[Object][85]** Query options. (optional, default `{}`)

    *   `options.limit` **[number][89]** Maximum number of records to return. (optional, default `50`)
    *   `options.offset` **[number][89]** Number of records to skip. (optional, default `0`)

Returns **[Promise][90]<[Array][92]<[Object][85]>>** List of rows.

### findById

Finds a single row by its ID.

#### Parameters

*   `id` **([number][89] | [string][86])** The primary key value.

<!---->

*   Throws **[Error][88]** If ID is invalid.

Returns **[Promise][90]<([Object][85] | null)>** Matching row or null if not found.

### findByIdIncludingDeactivated

Finds a single row by its ID, including soft-deleted records.

#### Parameters

*   `id` **([number][89] | [string][86])** The primary key value.

<!---->

*   Throws **[Error][88]** If ID is invalid.

Returns **[Promise][90]<([Object][85] | null)>** Matching row or null if not found.

### findWhere

Finds rows matching conditions and optional filters.

#### Parameters

*   `conditions` **[Array][92]<[Object][85]>** Array of condition objects. (optional, default `[]`)
*   `joinType` **[string][86]** Logical operator ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][85]** Query options. (optional, default `{}`)

    *   `options.columnWhitelist` **[Array][92]<[string][86]>?** Columns to return. (optional, default `null`)
    *   `options.filters` **[Object][85]?** Additional filter object. (optional, default `{}`)
    *   `options.orderBy` **([string][86] | [Array][92]<[string][86]>)?** Sort columns. (optional, default `null`)
    *   `options.limit` **[number][89]?** Limit results. (optional, default `null`)
    *   `options.offset` **[number][89]?** Offset results. (optional, default `null`)
    *   `options.includeDeactivated`   (optional, default `false`)

Returns **[Promise][90]<[Array][92]<[Object][85]>>** Matching rows.

### findOneBy

Finds the first row matching the given conditions.

#### Parameters

*   `conditions` **[Array][92]<[Object][85]>** Condition list.
*   `options` **[Object][85]?** Query options (same as findWhere). (optional, default `{}`)

Returns **[Promise][90]<([Object][85] | null)>** First matching row or null.

### exists

Checks if any row exists matching the given conditions.

#### Parameters

*   `conditions` **[Object][85]** Condition object.
*   `options` **[Object][85]?** Query options. (optional, default `{}`)

<!---->

*   Throws **[Error][88]** If conditions are invalid.

Returns **[Promise][90]<[boolean][91]>** True if a match is found.

### count

Counts the number of rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][85] | [Array][92]<[Object][85]>)** WHERE condition(s).
*   `options` **[Object][85]?** Query options. (optional, default `{}`)

Returns **[Promise][90]<[number][89]>** Number of matching rows.

### countAll

Counts all rows in the table.

Returns **[Promise][90]<[number][89]>** Total row count.

### escapeName

Escapes a column or table name using pg-promise syntax.

#### Parameters

*   `name` **[string][86]** Unescaped identifier.

Returns **[string][86]** Escaped name.

### setSchemaName

Sets a new schema name and regenerates the column set.

#### Parameters

*   `name` **[string][86]** The new schema name.

<!---->

*   Throws **[Error][88]** If name is invalid.

Returns **[QueryModel][50]** The updated model instance.

### buildWhereClause

Builds a SQL WHERE clause from conditions.

#### Parameters

*   `where` **([Object][85] | [Array][92]<[Object][85]>)** Conditions object or array. (optional, default `{}`)
*   `requireNonEmpty` **[boolean][91]** Enforce non-empty input. (optional, default `true`)
*   `values` **[Array][92]** Array to accumulate parameter values. (optional, default `[]`)
*   `joinType` **[string][86]** Logical operator for combining. (optional, default `'AND'`)
*   `includeDeactivated` **[boolean][91]** Include soft-deleted records if true. (optional, default `false`)

<!---->

*   Throws **[Error][88]** If input is invalid or empty when required.

Returns **{clause: [string][86], values: [Array][92]}** Clause and parameter list.

### buildCondition

Builds a SQL fragment from a group of conditions, supporting nested logic and advanced operators.

🔍 Supports field-level modifiers like `$like`, `$from`, `$in`, etc.
🔁 Also supports nested boolean logic via `$and`, `$or`, `and`, `or`.

📘 See full documentation:
[WHERE Clause Modifiers Reference][93]

#### Parameters

*   `group` **[Array][92]<[Object][85]>** Array of condition objects.
*   `joiner` **[string][86]** Logical joiner ('AND' or 'OR') between conditions. (optional, default `'AND'`)
*   `values` **[Array][92]** Parameter values to be populated. (optional, default `[]`)

Returns **[string][86]** A SQL-safe WHERE fragment.

### handleDbError

Handles known pg errors and logs them.

#### Parameters

*   `err` **[Error][88]** The error thrown by pg-promise.

<!---->

*   Throws **[DatabaseError][83]** Translated database error.

## callDb

Returns a schema-aware version of a registered model or repository.

### Parameters

*   `modelOrName` **([string][86] | [object][85])** The model instance or its name.
*   `schemaName` **[string][86]** The database schema to bind.

Returns **[object][85]** The model bound to the given schema.

## DatabaseError

**Extends Error**

Custom error class for representing PostgreSQL-related database errors.
Wraps the original error thrown by pg-promise or pg, and extracts useful metadata
such as the constraint name, table, and SQLSTATE error code.

### Parameters

*   `message` **[string][86]** A human-readable description of the error.
*   `originalError` **[Error][88]** The original error object from PostgreSQL.

[1]: #db

[2]: #init

[3]: #parameters

[4]: #pgp

[5]: #db-1

[6]: #tablemodel

[7]: #parameters-1

[8]: #delete

[9]: #parameters-2

[10]: #insert

[11]: #parameters-3

[12]: #reload

[13]: #parameters-4

[14]: #update

[15]: #parameters-5

[16]: #findaftercursor

[17]: #parameters-6

[18]: #deletewhere

[19]: #parameters-7

[20]: #touch

[21]: #parameters-8

[22]: #updatewhere

[23]: #parameters-9

[24]: #bulkinsert

[25]: #parameters-10

[26]: #bulkupdate

[27]: #parameters-11

[28]: #exporttospreadsheet

[29]: #parameters-12

[30]: #importfromspreadsheet

[31]: #parameters-13

[32]: #removewhere

[33]: #parameters-14

[34]: #restorewhere

[35]: #parameters-15

[36]: #purgesoftdeletewhere

[37]: #parameters-16

[38]: #purgesoftdeletebyid

[39]: #parameters-17

[40]: #validatedto

[41]: #parameters-18

[42]: #sanitizedto

[43]: #parameters-19

[44]: #truncate

[45]: #createtable

[46]: #schemadefinitionerror

[47]: #parameters-20

[48]: #createhash

[49]: #parameters-21

[50]: #querymodel

[51]: #parameters-22

[52]: #findsoftdeleted

[53]: #parameters-23

[54]: #issoftdeleted

[55]: #parameters-24

[56]: #findall

[57]: #parameters-25

[58]: #findbyid

[59]: #parameters-26

[60]: #findbyidincludingdeactivated

[61]: #parameters-27

[62]: #findwhere

[63]: #parameters-28

[64]: #findoneby

[65]: #parameters-29

[66]: #exists

[67]: #parameters-30

[68]: #count

[69]: #parameters-31

[70]: #countall

[71]: #escapename

[72]: #parameters-32

[73]: #setschemaname

[74]: #parameters-33

[75]: #buildwhereclause

[76]: #parameters-34

[77]: #buildcondition

[78]: #parameters-35

[79]: #handledberror

[80]: #parameters-36

[81]: #calldb

[82]: #parameters-37

[83]: #databaseerror

[84]: #parameters-38

[85]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[86]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[87]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[88]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error

[89]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[90]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

[91]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[92]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[93]: where-modifiers.md
