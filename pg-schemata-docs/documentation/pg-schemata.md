<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [DB][1]
    *   [init][2]
        *   [Parameters][3]
*   [pgp][4]
*   [TableModel][5]
    *   [Parameters][6]
    *   [insert][7]
        *   [Parameters][8]
    *   [delete][9]
        *   [Parameters][10]
    *   [update][11]
        *   [Parameters][12]
    *   [upsert][13]
        *   [Parameters][14]
    *   [bulkUpsert][15]
        *   [Parameters][16]
    *   [deleteWhere][17]
        *   [Parameters][18]
    *   [touch][19]
        *   [Parameters][20]
    *   [updateWhere][21]
        *   [Parameters][22]
    *   [bulkInsert][23]
        *   [Parameters][24]
    *   [bulkUpdate][25]
        *   [Parameters][26]
    *   [importFromSpreadsheet][27]
        *   [Parameters][28]
    *   [removeWhere][29]
        *   [Parameters][30]
    *   [restoreWhere][31]
        *   [Parameters][32]
    *   [purgeSoftDeleteWhere][33]
        *   [Parameters][34]
    *   [purgeSoftDeleteById][35]
        *   [Parameters][36]
    *   [truncate][37]
    *   [createTable][38]
*   [SchemaDefinitionError][39]
    *   [Parameters][40]
*   [createHash][41]
    *   [Parameters][42]
*   [QueryModel][43]
    *   [Parameters][44]
    *   [findSoftDeleted][45]
        *   [Parameters][46]
    *   [isSoftDeleted][47]
        *   [Parameters][48]
    *   [findAll][49]
        *   [Parameters][50]
    *   [findById][51]
        *   [Parameters][52]
    *   [findByIdIncludingDeactivated][53]
        *   [Parameters][54]
    *   [findWhere][55]
        *   [Parameters][56]
    *   [findOneBy][57]
        *   [Parameters][58]
    *   [findAfterCursor][59]
        *   [Parameters][60]
    *   [reload][61]
        *   [Parameters][62]
    *   [exportToSpreadsheet][63]
        *   [Parameters][64]
    *   [exists][65]
        *   [Parameters][66]
    *   [countWhere][67]
        *   [Parameters][68]
    *   [countAll][69]
        *   [Parameters][70]
    *   [buildValuesClause][71]
        *   [Parameters][72]
    *   [validateDto][73]
        *   [Parameters][74]
    *   [sanitizeDto][75]
        *   [Parameters][76]
    *   [escapeName][77]
        *   [Parameters][78]
    *   [setSchemaName][79]
        *   [Parameters][80]
    *   [buildWhereClause][81]
        *   [Parameters][82]
    *   [buildCondition][83]
        *   [Parameters][84]
    *   [handleDbError][85]
        *   [Parameters][86]
*   [callDb][87]
    *   [Parameters][88]
*   [DatabaseError][89]
    *   [Parameters][90]

## DB

DB is a singleton utility class that initializes and provides access
to a configured pg-promise database instance. It also auto-attaches
custom repositories to the DB object on first initialization.

Use `DB.init(connection, repositories)` once at startup to initialize the DB.
Then access `DB.db` and `DB.pgp` as needed throughout your application.

### init

Initializes the DB singleton if it hasn't been initialized yet.

#### Parameters

*   `connection` **([object][91] | [string][92])** A pg-promise-compatible connection object or string.
*   `repositories` **[Object][91]<[string][92], [Function][93]>** A map of repository names to their constructors.
*   `logger` **[object][91]** Optional logger passed to each repository. (optional, default `null`)

<!---->

*   Throws **[Error][94]** If connection or repositories are invalid.

## pgp

The initialized pg-promise instance.

## TableModel

**Extends QueryModel**

TableModel extends QueryModel to provide full read/write support for a PostgreSQL table.

Adds create, update, and delete capabilities on top of the read-only features in QueryModel,
along with support for spreadsheet import/export, validation, and conditional mutations.

✅ Features:

*   Full CRUD: `insert`, `update`, `delete`, `deleteWhere`, `updateWhere`
*   Cursor-based and paginated queries via `findAfterCursor`
*   Bulk operations: `bulkInsert`, `bulkUpdate`
*   Data import/export: `importFromSpreadsheet`, `exportToSpreadsheet`
*   Auto Zod schema validation and field sanitization

This class is the standard entry point for interacting with a single table in pg-schemata.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger` &#x20;

### insert

Inserts a single row into the table after validation and sanitization.

#### Parameters

*   `dto` **[Object][91]** Data to insert.

<!---->

*   Throws **[SchemaDefinitionError][39]** If validation fails or DTO is invalid.

Returns **[Promise][95]<[Object][91]>** The inserted row.

### delete

Deletes a record by its ID.

#### Parameters

*   `id` **([string][92] | [number][96])** Primary key of the row to delete.

<!---->

*   Throws **[Error][94]** If the ID is invalid or deletion fails.

Returns **[Promise][95]<[number][96]>** Number of rows deleted.

### update

Updates a record by ID with new data.

#### Parameters

*   `id` **([string][92] | [number][96])** Primary key value.
*   `dto` **[Object][91]** Updated values.

<!---->

*   Throws **[SchemaDefinitionError][39]** If ID or DTO is invalid.

Returns **[Promise][95]<([Object][91] | null)>** Updated record or null if not found.

### upsert

Inserts a record or updates it if it conflicts with specified columns.

#### Parameters

*   `dto` **[Object][91]** Data to insert or update.
*   `conflictColumns` **[Array][97]<[string][92]>** Columns that define the conflict constraint.
*   `updateColumns` **[Array][97]<[string][92]>?** Columns to update on conflict. Defaults to all non-conflict columns. (optional, default `null`)

Returns **[Promise][95]<[Object][91]>** The inserted or updated row.

### bulkUpsert

Bulk upsert multiple records in a single transaction.

#### Parameters

*   `records` **[Array][97]<[Object][91]>** Array of records to upsert.
*   `conflictColumns` **[Array][97]<[string][92]>** Columns that define the conflict constraint.
*   `updateColumns` **[Array][97]<[string][92]>?** Columns to update on conflict. Defaults to all non-conflict columns. (optional, default `null`)
*   `returning` **([Array][97]<[string][92]> | null)** Optional array of columns to return. (optional, default `null`)

Returns **[Promise][95]<([number][96] | [Array][97])>** Number of rows affected or array of rows if returning specified.

### deleteWhere

Deletes rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][91] | [Array][97])** Filter criteria.

Returns **[Promise][95]<[number][96]>** Number of rows deleted.

### touch

Updates only the updated\_by timestamp for a given row.

#### Parameters

*   `id` **([string][92] | [number][96])** Primary key.
*   `updatedBy` **[string][92]** User performing the update. (optional, default `'system'`)

Returns **[Promise][95]<([Object][91] | null)>** Updated row.

### updateWhere

Updates rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][91] | [Array][97])** Conditions.
*   `updates` **[Object][91]** Fields to update.
*   `options` **[Object][91]** Additional options (e.g., includeDeactivated). (optional, default `{}`)

<!---->

*   Throws **[SchemaDefinitionError][39]** If input is invalid.

Returns **[Promise][95]<[number][96]>** Number of rows updated.

### bulkInsert

Inserts many rows in a single batch operation, with optional RETURNING support.

#### Parameters

*   `records` **[Array][97]<[Object][91]>** Rows to insert.
*   `returning` **([Array][97]<[string][92]> | null)** Optional array of columns to return. (optional, default `null`)

<!---->

*   Throws **[SchemaDefinitionError][39]** If records or returning are invalid.

Returns **[Promise][95]<([number][96] | [Array][97]<[Object][91]>)>** Number of rows inserted, or array of rows if returning specified.

### bulkUpdate

Updates multiple rows using their primary keys.

#### Parameters

*   `records` **[Array][97]<[Object][91]>** Each must include an ID field.
*   `returning` **([Array][97]<[string][92]> | null)** Optional array of columns to return. (optional, default `null`)

<!---->

*   Throws **[SchemaDefinitionError][39]** If input or IDs are invalid.

Returns **[Promise][95]<[Array][97]>** Array of row counts or updated rows per query.

### importFromSpreadsheet

Loads data from an Excel file and inserts it into the table.
Each row can be transformed using an optional callback before insertion.

#### Parameters

*   `filePath` **[string][92]** Source .xlsx file path.
*   `sheetIndex` **[number][96]** Sheet index to load. (optional, default `0`)
*   `callbackFn`   (optional, default `null`)
*   `returning`   (optional, default `null`)

<!---->

*   Throws **[SchemaDefinitionError][39]** If file format is invalid or spreadsheet is empty.

Returns **[Promise][95]<{inserted: [number][96]}>** Number of rows inserted.

### removeWhere

Soft deletes records matching a WHERE clause by setting deactivated\_at = NOW().

#### Parameters

*   `where` **([Object][91] | [Array][97])** Filter criteria.

Returns **[Promise][95]<[number][96]>** Number of rows updated.

### restoreWhere

Restores previously soft-deleted records by setting deactivated\_at = NULL.

#### Parameters

*   `where` **([Object][91] | [Array][97])** Filter criteria.

Returns **[Promise][95]<[number][96]>** Number of rows updated.

### purgeSoftDeleteWhere

Permanently deletes soft-deleted records that match a given condition.
Useful for scheduled cleanup of records older than a threshold.

#### Parameters

*   `where` **([Object][91] | [Array][97]<[Object][91]>)** Filter conditions. (optional, default `[]`)

Returns **[Promise][95]<[Object][91]>** pg-promise result.

### purgeSoftDeleteById

Permanently deletes a soft-deleted row by ID.

#### Parameters

*   `id` **([string][92] | [number][96])** Primary key value.

Returns **[Promise][95]<[Object][91]>** pg-promise result.

### truncate

Truncates the table and resets its identity sequence.

Returns **[Promise][95]\<void>**&#x20;

### createTable

Creates the table using the current schema definition.

Returns **[Promise][95]\<void>**&#x20;

## SchemaDefinitionError

**Extends Error**

Custom error used to indicate problems with table schema definitions or data validation
within pg-schemata. This is typically thrown during insert/update validation or schema parsing.

### Parameters

*   `message` **[string][92]** Error message describing the schema issue.
*   `originalError` **([Error][94] | null)** Optional original error cause for tracing. (optional, default `null`)

## createHash

Creates a short MD5-based hash of the input string.

### Parameters

*   `input` **[string][92]** Value to hash.

Returns **[string][92]** A 6-character hex hash.

## QueryModel

QueryModel provides reusable read-only query logic for PostgreSQL tables.

Designed for models that require flexible query-building capabilities, either as a standalone
read-only interface or to be extended for full CRUD functionality.

It may be instantiated directly when only read-access is required.

✅ Features:

*   Dynamic WHERE clause generation via `buildWhereClause` and `buildCondition`
*   Query helpers: `findWhere`, `findAll`, `findOneBy`
*   Aggregations and checks: `count`, `countAll`, `exists`
*   Rich condition syntax with `$like`, `$from`, `$eq`, `$in`, `$and`, `$or`, etc.

📌 See [where-modifiers.md][98] for full reference.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger`   (optional, default `null`)

### findSoftDeleted

Finds only soft-deleted records.

#### Parameters

*   `conditions` **[Array][97]<[Object][91]>** Optional extra conditions. (optional, default `[]`)
*   `joinType` **[string][92]** Logical joiner ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][91]** Query options. (optional, default `{}`)

Returns **[Promise][95]<[Array][97]<[Object][91]>>** Soft-deleted rows.

### isSoftDeleted

Checks if a specific record is soft-deleted.

#### Parameters

*   `id` **([number][96] | [string][92])** The primary key value.

Returns **[Promise][95]<[boolean][99]>** True if the record is soft-deleted, false otherwise.

### findAll

Fetches all rows from the table with optional pagination.

#### Parameters

*   `options` **[Object][91]** Query options. (optional, default `{}`)

    *   `options.limit` **[number][96]** Maximum number of records to return. (optional, default `50`)
    *   `options.offset` **[number][96]** Number of records to skip. (optional, default `0`)

Returns **[Promise][95]<[Array][97]<[Object][91]>>** List of rows.

### findById

Finds a single row by its ID.

#### Parameters

*   `id` **([number][96] | [string][92])** The primary key value.

<!---->

*   Throws **[Error][94]** If ID is invalid.

Returns **[Promise][95]<([Object][91] | null)>** Matching row or null if not found.

### findByIdIncludingDeactivated

Finds a single row by its ID, including soft-deleted records.

#### Parameters

*   `id` **([number][96] | [string][92])** The primary key value.

<!---->

*   Throws **[Error][94]** If ID is invalid.

Returns **[Promise][95]<([Object][91] | null)>** Matching row or null if not found.

### findWhere

Finds rows matching conditions and optional filters.

#### Parameters

*   `conditions` **[Array][97]<[Object][91]>** Array of condition objects. (optional, default `[]`)
*   `joinType` **[string][92]** Logical operator ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][91]** Query options. (optional, default `{}`)

    *   `options.columnWhitelist` **[Array][97]<[string][92]>?** Columns to return. (optional, default `null`)
    *   `options.filters` **[Object][91]?** Additional filter object. (optional, default `{}`)
    *   `options.orderBy` **([string][92] | [Array][97]<[string][92]>)?** Sort columns. (optional, default `null`)
    *   `options.limit` **[number][96]?** Limit results. (optional, default `null`)
    *   `options.offset` **[number][96]?** Offset results. (optional, default `null`)
    *   `options.includeDeactivated` **[boolean][99]** Include soft-deleted records when true. (optional, default `false`)

Returns **[Promise][95]<[Array][97]<[Object][91]>>** Matching rows.

### findOneBy

Finds the first row matching the given conditions.

#### Parameters

*   `conditions` **[Array][97]<[Object][91]>** Condition list.
*   `options` **[Object][91]?** Query options (same as findWhere). (optional, default `{}`)

Returns **[Promise][95]<([Object][91] | null)>** First matching row or null.

### findAfterCursor

Retrieves a paginated set of rows after a cursor position.

#### Parameters

*   `cursor` **[Object][91]** Cursor values keyed by orderBy columns. (optional, default `{}`)
*   `limit` **[number][96]** Max number of rows to return. (optional, default `50`)
*   `orderBy` **[Array][97]<[string][92]>** Columns used for pagination ordering. (optional, default `['id']`)
*   `options` **[Object][91]** Query options. (optional, default `{}`)

    *   `options.columnWhitelist` **[Array][97]<[string][92]>?** Columns to return.
    *   `options.filters` **[Object][91]?** Additional filter object.
    *   `options.includeDeactivated` **[boolean][99]** Include soft-deleted records when true. (optional, default `false`)

### reload

Reloads a single record by ID using findById.

#### Parameters

*   `id` **([string][92] | [number][96])** Primary key value.
*   `options` **[Object][91]?** Optional flags. (optional, default `{}`)

    *   `options.includeDeactivated` **[boolean][99]** Whether to include soft-deleted records. (optional, default `false`)

Returns **[Promise][95]<([Object][91] | null)>** The found record or null.

### exportToSpreadsheet

Exports table data to an Excel file based on filter criteria.

#### Parameters

*   `filePath` **[string][92]** Destination .xlsx path.
*   `where` **[Array][97]** Optional conditions. (optional, default `[]`)
*   `joinType` **[string][92]** Join type between conditions. (optional, default `'AND'`)
*   `options` **[Object][91]** Additional query options. (optional, default `{}`)

Returns **[Promise][95]<{exported: [number][96], filePath: [string][92]}>**&#x20;

### exists

Checks if any row exists matching the given conditions.

#### Parameters

*   `conditions` **[Object][91]** Condition object.
*   `options` **[Object][91]?** Query options. (optional, default `{}`)

<!---->

*   Throws **[Error][94]** If conditions are invalid.

Returns **[Promise][95]<[boolean][99]>** True if a match is found.

### countWhere

Counts the number of rows matching a WHERE clause.

#### Parameters

*   `conditions` **[Array][97]<[Object][91]>** Array of condition objects. (optional, default `[]`)
*   `joinType` **[string][92]** Logical joiner ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][91]** Query options. (optional, default `{}`)

    *   `options.filters` **[Object][91]?** Additional filter object. (optional, default `{}`)
    *   `options.includeDeactivated` **[boolean][99]** Include soft-deleted records when true. (optional, default `false`)

Returns **[Promise][95]<[number][96]>** Number of matching rows.

### countAll

Counts all rows in the table.

#### Parameters

*   `options` **[Object][91]?** Query options. (optional, default `{}`)

    *   `options.includeDeactivated` **[boolean][99]** Include soft-deleted records when true. (optional, default `false`)

Returns **[Promise][95]<[number][96]>** Total row count.

### buildValuesClause

Generates a SQL-safe VALUES clause using this model's ColumnSet.

#### Parameters

*   `data` **[Array][97]<([Object][91] | [Array][97])>** Array of rows (object or array form)

Returns **[string][92]** VALUES clause for direct embedding in SQL

### validateDto

Validates a single DTO or an array of DTOs using a Zod validator.

#### Parameters

*   `data` **([Object][91] | [Array][97]<[Object][91]>)** The DTO or array of DTOs to validate.
*   `validator` &#x20;
*   `type` **[string][92]** Optional label used in error messages. (optional, default `'DTO'`)

<!---->

*   Throws **[SchemaDefinitionError][39]** If validation fails. The `.cause` property contains Zod error details.

### sanitizeDto

Returns a sanitized copy of the input, filtering out invalid or immutable columns.

#### Parameters

*   `dto` **[Object][91]** Input object.
*   `options` **[Object][91]?**  (optional, default `{}`)

    *   `options.includeImmutable` **[boolean][99]**  (optional, default `true`)

Returns **[Object][91]** Sanitized DTO.

### escapeName

Escapes a column or table name using pg-promise syntax.

#### Parameters

*   `name` **[string][92]** Unescaped identifier.

Returns **[string][92]** Escaped name.

### setSchemaName

Sets a new schema name and regenerates the column set.

#### Parameters

*   `name` **[string][92]** The new schema name.

<!---->

*   Throws **[Error][94]** If name is invalid.

Returns **[QueryModel][43]** The updated model instance.

### buildWhereClause

Builds a SQL WHERE clause from conditions.

#### Parameters

*   `where` **([Object][91] | [Array][97]<[Object][91]>)** Conditions object or array. (optional, default `{}`)
*   `requireNonEmpty` **[boolean][99]** Enforce non-empty input. (optional, default `true`)
*   `values` **[Array][97]** Array to accumulate parameter values. (optional, default `[]`)
*   `joinType` **[string][92]** Logical operator for combining. (optional, default `'AND'`)
*   `includeDeactivated` **[boolean][99]** Include soft-deleted records if true. (optional, default `false`)

<!---->

*   Throws **[Error][94]** If input is invalid or empty when required.

Returns **{clause: [string][92], values: [Array][97]}** Clause and parameter list.

### buildCondition

Builds a SQL fragment from a group of conditions, supporting nested logic and advanced operators.

🔍 Supports field-level modifiers like `$like`, `$from`, `$in`, etc.
🔁 Also supports nested boolean logic via `$and`, `$or`, `and`, `or`.

📘 See full documentation:
[WHERE Clause Modifiers Reference][98]

#### Parameters

*   `group` **[Array][97]<[Object][91]>** Array of condition objects.
*   `joiner` **[string][92]** Logical joiner ('AND' or 'OR') between conditions. (optional, default `'AND'`)
*   `values` **[Array][97]** Parameter values to be populated. (optional, default `[]`)

Returns **[string][92]** A SQL-safe WHERE fragment.

### handleDbError

Handles known pg errors and logs them.

#### Parameters

*   `err` **[Error][94]** The error thrown by pg-promise.

<!---->

*   Throws **[DatabaseError][89]** Translated database error.

## callDb

Returns a schema-aware version of a registered model or repository.

### Parameters

*   `modelOrName` **([string][92] | [object][91])** The model instance or its name.
*   `schemaName` **[string][92]** The database schema to bind.

Returns **[object][91]** The model bound to the given schema.

## DatabaseError

**Extends Error**

Custom error class for representing PostgreSQL-related database errors.
Wraps the original error thrown by pg-promise or pg, and extracts useful metadata
such as the constraint name, table, and SQLSTATE error code.

### Parameters

*   `message` **[string][92]** A human-readable description of the error.
*   `originalError` **[Error][94]** The original error object from PostgreSQL.

[1]: #db

[2]: #init

[3]: #parameters

[4]: #pgp

[5]: #tablemodel

[6]: #parameters-1

[7]: #insert

[8]: #parameters-2

[9]: #delete

[10]: #parameters-3

[11]: #update

[12]: #parameters-4

[13]: #upsert

[14]: #parameters-5

[15]: #bulkupsert

[16]: #parameters-6

[17]: #deletewhere

[18]: #parameters-7

[19]: #touch

[20]: #parameters-8

[21]: #updatewhere

[22]: #parameters-9

[23]: #bulkinsert

[24]: #parameters-10

[25]: #bulkupdate

[26]: #parameters-11

[27]: #importfromspreadsheet

[28]: #parameters-12

[29]: #removewhere

[30]: #parameters-13

[31]: #restorewhere

[32]: #parameters-14

[33]: #purgesoftdeletewhere

[34]: #parameters-15

[35]: #purgesoftdeletebyid

[36]: #parameters-16

[37]: #truncate

[38]: #createtable

[39]: #schemadefinitionerror

[40]: #parameters-17

[41]: #createhash

[42]: #parameters-18

[43]: #querymodel

[44]: #parameters-19

[45]: #findsoftdeleted

[46]: #parameters-20

[47]: #issoftdeleted

[48]: #parameters-21

[49]: #findall

[50]: #parameters-22

[51]: #findbyid

[52]: #parameters-23

[53]: #findbyidincludingdeactivated

[54]: #parameters-24

[55]: #findwhere

[56]: #parameters-25

[57]: #findoneby

[58]: #parameters-26

[59]: #findaftercursor

[60]: #parameters-27

[61]: #reload

[62]: #parameters-28

[63]: #exporttospreadsheet

[64]: #parameters-29

[65]: #exists

[66]: #parameters-30

[67]: #countwhere

[68]: #parameters-31

[69]: #countall

[70]: #parameters-32

[71]: #buildvaluesclause

[72]: #parameters-33

[73]: #validatedto

[74]: #parameters-34

[75]: #sanitizedto

[76]: #parameters-35

[77]: #escapename

[78]: #parameters-36

[79]: #setschemaname

[80]: #parameters-37

[81]: #buildwhereclause

[82]: #parameters-38

[83]: #buildcondition

[84]: #parameters-39

[85]: #handledberror

[86]: #parameters-40

[87]: #calldb

[88]: #parameters-41

[89]: #databaseerror

[90]: #parameters-42

[91]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[92]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[93]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[94]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error

[95]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

[96]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[97]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[98]: where-modifiers.md

[99]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean
