<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

*   [DB][1]
    *   [init][2]
        *   [Parameters][3]
*   [pgp][4]
*   [db][5]
*   [TableModel][6]
    *   [Parameters][7]
    *   [delete][8]
        *   [Parameters][9]
    *   [insert][10]
        *   [Parameters][11]
    *   [reload][12]
        *   [Parameters][13]
    *   [update][14]
        *   [Parameters][15]
    *   [findAfterCursor][16]
        *   [Parameters][17]
    *   [deleteWhere][18]
        *   [Parameters][19]
    *   [touch][20]
        *   [Parameters][21]
    *   [updateWhere][22]
        *   [Parameters][23]
    *   [bulkInsert][24]
        *   [Parameters][25]
    *   [bulkUpdate][26]
        *   [Parameters][27]
    *   [exportToSpreadsheet][28]
        *   [Parameters][29]
    *   [importFromSpreadsheet][30]
        *   [Parameters][31]
    *   [sanitizeDto][32]
        *   [Parameters][33]
    *   [setSchema][34]
        *   [Parameters][35]
    *   [truncate][36]
    *   [withSchema][37]
        *   [Parameters][38]
    *   [createTable][39]
*   [QueryModel][40]
    *   [Parameters][41]
    *   [findAll][42]
        *   [Parameters][43]
    *   [findById][44]
        *   [Parameters][45]
    *   [findWhere][46]
        *   [Parameters][47]
    *   [findOneBy][48]
        *   [Parameters][49]
    *   [exists][50]
        *   [Parameters][51]
    *   [count][52]
        *   [Parameters][53]
    *   [countAll][54]
    *   [escapeName][55]
        *   [Parameters][56]
    *   [setSchemaName][57]
        *   [Parameters][58]
    *   [buildWhereClause][59]
        *   [Parameters][60]
    *   [buildCondition][61]
        *   [Parameters][62]
    *   [handleDbError][63]
        *   [Parameters][64]
*   [SchemaDefinitionError][65]
    *   [Parameters][66]
*   [createHash][67]
    *   [Parameters][68]
*   [callDb][69]
    *   [Parameters][70]
*   [DatabaseError][71]
    *   [Parameters][72]

## DB

DB is a singleton utility class that initializes and provides access
to a configured pg-promise database instance. It also auto-attaches
custom repositories to the DB object on first initialization.

Use `DB.init(connection, repositories)` once at startup to initialize the DB.
Then access `DB.db` and `DB.pgp` as needed throughout your application.

### init

Initializes the DB singleton if it hasn't been initialized yet.

#### Parameters

*   `connection` **([object][73] | [string][74])** A pg-promise-compatible connection object or string.
*   `repositories` **[Object][73]<[string][74], [Function][75]>** A map of repository names to their constructors.
*   `logger` **[object][73]** Optional logger passed to each repository. (optional, default `null`)

<!---->

*   Throws **[Error][76]** If connection or repositories are invalid.

## pgp

The initialized pg-promise instance.

## db

The initialized pg-promise database instance.

## TableModel

**Extends QueryModel**

TableModel extends QueryModel to provide full read/write support for a PostgreSQL table.

Adds create, update, and delete capabilities on top of the read-only features in QueryModel,
along with support for spreadsheet import/export, validation, and conditional mutations.

✅ Features:

*   Full CRUD: `insert`, `update`, `delete`, `deleteWhere`, `updateWhere`
*   Cursor-based and paginated queries via `findAfterCursor`
*   Bulk operations: `bulkInsert`, `bulkUpdate`
*   Data import/export: `importFromSpreadsheet`, `exportToSpreadsheet`
*   Auto Zod schema validation and field sanitization

This class is the standard entry point for interacting with a single table in pg-schemata.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger` &#x20;

### delete

Deletes a record by its ID.

#### Parameters

*   `id` **([string][74] | [number][77])** Primary key of the row to delete.

<!---->

*   Throws **[Error][76]** If the ID is invalid or deletion fails.

Returns **[Promise][78]<[number][77]>** Number of rows deleted.

### insert

Inserts a single row into the table after validation and sanitization.

#### Parameters

*   `dto` **[Object][73]** Data to insert.

<!---->

*   Throws **[SchemaDefinitionError][65]** If validation fails or DTO is invalid.

Returns **[Promise][78]<[Object][73]>** The inserted row.

### reload

Reloads a single record by ID using findById.

#### Parameters

*   `id` **([string][74] | [number][77])** Primary key value.

Returns **[Promise][78]<([Object][73] | null)>** The found record or null.

### update

Updates a record by ID with new data.

#### Parameters

*   `id` **([string][74] | [number][77])** Primary key value.
*   `dto` **[Object][73]** Updated values.

<!---->

*   Throws **[SchemaDefinitionError][65]** If ID or DTO is invalid.

Returns **[Promise][78]<([Object][73] | null)>** Updated record or null if not found.

### findAfterCursor

Retrieves a paginated set of rows after a cursor position.

#### Parameters

*   `cursor` **[Object][73]** Cursor values keyed by orderBy columns. (optional, default `{}`)
*   `limit` **[number][77]** Max number of rows to return. (optional, default `50`)
*   `orderBy` **[Array][79]<[string][74]>** Columns used for pagination ordering. (optional, default `['id']`)
*   `options` **[Object][73]** Extra filters and options. (optional, default `{}`)

### deleteWhere

Deletes rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][73] | [Array][79])** Filter criteria.

Returns **[Promise][78]<[number][77]>** Number of rows deleted.

### touch

Updates only the updated\_by timestamp for a given row.

#### Parameters

*   `id` **([string][74] | [number][77])** Primary key.
*   `updatedBy` **[string][74]** User performing the update. (optional, default `'system'`)

Returns **[Promise][78]<([Object][73] | null)>** Updated row.

### updateWhere

Updates rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][73] | [Array][79])** Conditions.
*   `updates` **[Object][73]** Fields to update.

<!---->

*   Throws **[SchemaDefinitionError][65]** If input is invalid.

Returns **[Promise][78]<[number][77]>** Number of rows updated.

### bulkInsert

Inserts many rows in a single batch operation.

#### Parameters

*   `records` **[Array][79]<[Object][73]>** Rows to insert.

<!---->

*   Throws **[SchemaDefinitionError][65]** If records are invalid.

Returns **[Promise][78]<[number][77]>** Number of rows inserted.

### bulkUpdate

Updates multiple rows using their primary keys.

#### Parameters

*   `records` **[Array][79]<[Object][73]>** Each must include an ID field.

<!---->

*   Throws **[SchemaDefinitionError][65]** If input or IDs are invalid.

Returns **[Promise][78]<[Array][79]<[number][77]>>** Array of row counts updated per query.

### exportToSpreadsheet

Exports table data to an Excel file based on filter criteria.

#### Parameters

*   `filePath` **[string][74]** Destination .xlsx path.
*   `where` **[Array][79]** Optional conditions. (optional, default `[]`)
*   `joinType` **[string][74]** Join type between conditions. (optional, default `'AND'`)
*   `options` **[Object][73]** Additional query options. (optional, default `{}`)

Returns **[Promise][78]<{exported: [number][77], filePath: [string][74]}>**&#x20;

### importFromSpreadsheet

Loads data from an Excel file and inserts it into the table.

#### Parameters

*   `filePath` **[string][74]** Source .xlsx file path.
*   `sheetIndex` **[number][77]** Sheet index to load. (optional, default `0`)

<!---->

*   Throws **[SchemaDefinitionError][65]** If file format is invalid.

Returns **[Promise][78]<{inserted: [number][77]}>**&#x20;

### sanitizeDto

Returns a sanitized copy of the input, filtering out invalid or immutable columns.

#### Parameters

*   `dto` **[Object][73]** Input object.
*   `options` **[Object][73]?**  (optional, default `{}`)

    *   `options.includeImmutable` **[boolean][80]**  (optional, default `true`)

Returns **[Object][73]** Sanitized DTO.

### setSchema

Sets a new schema name in the internal schema.

#### Parameters

*   `dbSchema` **[string][74]** New schema name.

### truncate

Truncates the table and resets its identity sequence.

Returns **[Promise][78]\<void>**&#x20;

### withSchema

Sets a new schema name and returns the current model instance.

#### Parameters

*   `dbSchema` **[string][74]** New schema name.

Returns **[TableModel][6]**&#x20;

### createTable

Creates the table using the current schema definition.

Returns **[Promise][78]\<void>**&#x20;

## QueryModel

QueryModel provides reusable read-only query logic for PostgreSQL tables.

Designed for models that require flexible query-building capabilities, either as a standalone
read-only interface or to be extended for full CRUD functionality.

It may be instantiated directly when only read-access is required.

✅ Features:

*   Dynamic WHERE clause generation via `buildWhereClause` and `buildCondition`
*   Query helpers: `findWhere`, `findAll`, `findOneBy`
*   Aggregations and checks: `count`, `countAll`, `exists`
*   Rich condition syntax with `$like`, `$from`, `$eq`, `$in`, `$and`, `$or`, etc.

📌 See [where-modifiers.md][81] for full reference.

### Parameters

*   `db` &#x20;
*   `pgp` &#x20;
*   `schema` &#x20;
*   `logger`   (optional, default `null`)

### findAll

Fetches all rows from the table with optional pagination.

#### Parameters

*   `options` **[Object][73]** Query options. (optional, default `{}`)

    *   `options.limit` **[number][77]** Maximum number of records to return. (optional, default `50`)
    *   `options.offset` **[number][77]** Number of records to skip. (optional, default `0`)

Returns **[Promise][78]<[Array][79]<[Object][73]>>** List of rows.

### findById

Finds a single row by its ID.

#### Parameters

*   `id` **([number][77] | [string][74])** The primary key value.

<!---->

*   Throws **[Error][76]** If ID is invalid.

Returns **[Promise][78]<([Object][73] | null)>** Matching row or null if not found.

### findWhere

Finds rows matching conditions and optional filters.

#### Parameters

*   `conditions` **[Array][79]<[Object][73]>** Array of condition objects. (optional, default `[]`)
*   `joinType` **[string][74]** Logical operator ('AND' or 'OR'). (optional, default `'AND'`)
*   `options` **[Object][73]** Query options. (optional, default `{}`)

    *   `options.columnWhitelist` **[Array][79]<[string][74]>?** Columns to return. (optional, default `null`)
    *   `options.filters` **[Object][73]?** Additional filter object. (optional, default `{}`)
    *   `options.orderBy` **([string][74] | [Array][79]<[string][74]>)?** Sort columns. (optional, default `null`)
    *   `options.limit` **[number][77]?** Limit results. (optional, default `null`)
    *   `options.offset` **[number][77]?** Offset results. (optional, default `null`)

Returns **[Promise][78]<[Array][79]<[Object][73]>>** Matching rows.

### findOneBy

Finds the first row matching the given conditions.

#### Parameters

*   `conditions` **[Array][79]<[Object][73]>** Condition list.
*   `options` **[Object][73]?** Query options (same as findWhere). (optional, default `{}`)

Returns **[Promise][78]<([Object][73] | null)>** First matching row or null.

### exists

Checks if any row exists matching the given conditions.

#### Parameters

*   `conditions` **[Object][73]** Condition object.

<!---->

*   Throws **[Error][76]** If conditions are invalid.

Returns **[Promise][78]<[boolean][80]>** True if a match is found.

### count

Counts the number of rows matching a WHERE clause.

#### Parameters

*   `where` **([Object][73] | [Array][79]<[Object][73]>)** WHERE condition(s).

Returns **[Promise][78]<[number][77]>** Number of matching rows.

### countAll

Counts all rows in the table.

Returns **[Promise][78]<[number][77]>** Total row count.

### escapeName

Escapes a column or table name using pg-promise syntax.

#### Parameters

*   `name` **[string][74]** Unescaped identifier.

Returns **[string][74]** Escaped name.

### setSchemaName

Sets a new schema name and regenerates the column set.

#### Parameters

*   `name` **[string][74]** The new schema name.

<!---->

*   Throws **[Error][76]** If name is invalid.

Returns **[QueryModel][40]** The updated model instance.

### buildWhereClause

Builds a SQL WHERE clause from conditions.

#### Parameters

*   `where` **([Object][73] | [Array][79]<[Object][73]>)** Conditions object or array. (optional, default `{}`)
*   `requireNonEmpty` **[boolean][80]** Enforce non-empty input. (optional, default `true`)
*   `values` **[Array][79]** Array to accumulate parameter values. (optional, default `[]`)
*   `joinType` **[string][74]** Logical operator for combining. (optional, default `'AND'`)

<!---->

*   Throws **[Error][76]** If input is invalid or empty when required.

Returns **{clause: [string][74], values: [Array][79]}** Clause and parameter list.

### buildCondition

Builds a SQL fragment from a group of conditions, supporting nested logic and advanced operators.

🔍 Supports field-level modifiers like `$like`, `$from`, `$in`, etc.
🔁 Also supports nested boolean logic via `$and`, `$or`, `and`, `or`.

📘 See full documentation:
[WHERE Clause Modifiers Reference][81]

#### Parameters

*   `group` **[Array][79]<[Object][73]>** Array of condition objects.
*   `joiner` **[string][74]** Logical joiner ('AND' or 'OR') between conditions. (optional, default `'AND'`)
*   `values` **[Array][79]** Parameter values to be populated. (optional, default `[]`)

Returns **[string][74]** A SQL-safe WHERE fragment.

### handleDbError

Handles known pg errors and logs them.

#### Parameters

*   `err` **[Error][76]** The error thrown by pg-promise.

<!---->

*   Throws **[DatabaseError][71]** Translated database error.

## SchemaDefinitionError

**Extends Error**

Custom error used to indicate problems with table schema definitions or data validation
within pg-schemata. This is typically thrown during insert/update validation or schema parsing.

### Parameters

*   `message` **[string][74]** Error message describing the schema issue.
*   `originalError` **([Error][76] | null)** Optional original error cause for tracing. (optional, default `null`)

## createHash

Creates a short MD5-based hash of the input string.

### Parameters

*   `input` **[string][74]** Value to hash.

Returns **[string][74]** A 6-character hex hash.

## callDb

Returns a schema-aware version of a registered model or repository.

### Parameters

*   `modelOrName` **([string][74] | [object][73])** The model instance or its name.
*   `schemaName` **[string][74]** The database schema to bind.

Returns **[object][73]** The model bound to the given schema.

## DatabaseError

**Extends Error**

Custom error class for representing PostgreSQL-related database errors.
Wraps the original error thrown by pg-promise or pg, and extracts useful metadata
such as the constraint name, table, and SQLSTATE error code.

### Parameters

*   `message` **[string][74]** A human-readable description of the error.
*   `originalError` **[Error][76]** The original error object from PostgreSQL.

[1]: #db

[2]: #init

[3]: #parameters

[4]: #pgp

[5]: #db-1

[6]: #tablemodel

[7]: #parameters-1

[8]: #delete

[9]: #parameters-2

[10]: #insert

[11]: #parameters-3

[12]: #reload

[13]: #parameters-4

[14]: #update

[15]: #parameters-5

[16]: #findaftercursor

[17]: #parameters-6

[18]: #deletewhere

[19]: #parameters-7

[20]: #touch

[21]: #parameters-8

[22]: #updatewhere

[23]: #parameters-9

[24]: #bulkinsert

[25]: #parameters-10

[26]: #bulkupdate

[27]: #parameters-11

[28]: #exporttospreadsheet

[29]: #parameters-12

[30]: #importfromspreadsheet

[31]: #parameters-13

[32]: #sanitizedto

[33]: #parameters-14

[34]: #setschema

[35]: #parameters-15

[36]: #truncate

[37]: #withschema

[38]: #parameters-16

[39]: #createtable

[40]: #querymodel

[41]: #parameters-17

[42]: #findall

[43]: #parameters-18

[44]: #findbyid

[45]: #parameters-19

[46]: #findwhere

[47]: #parameters-20

[48]: #findoneby

[49]: #parameters-21

[50]: #exists

[51]: #parameters-22

[52]: #count

[53]: #parameters-23

[54]: #countall

[55]: #escapename

[56]: #parameters-24

[57]: #setschemaname

[58]: #parameters-25

[59]: #buildwhereclause

[60]: #parameters-26

[61]: #buildcondition

[62]: #parameters-27

[63]: #handledberror

[64]: #parameters-28

[65]: #schemadefinitionerror

[66]: #parameters-29

[67]: #createhash

[68]: #parameters-30

[69]: #calldb

[70]: #parameters-31

[71]: #databaseerror

[72]: #parameters-32

[73]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[74]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String

[75]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[76]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Error

[77]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[78]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise

[79]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[80]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[81]: where-modifiers.md
